# LionWeb integration testing

Automated tests that check that the other repos within the [LionWeb GitHub](https://github.com/LionWeb-io) integrate well and consistently with each other.
The definition of “well” in the previous sentences is not very broad — effectively it means: the build runs green.
With “build” we mean the [GitHub Action](https://github.com/LionWeb-io/lionweb-integration-testing/actions/workflows/build.yaml).

Note that this repository serves as a **“canary in a coal mine”**: if its build turns red, it means there's a mismatch(/incompatibility) between either an implementation and the specification (and/or between implementations).
That also means that modifications and additions to this repository – in the form of PRs – might turn the build red when run on the PR's branch.
That is a good thing: it means that the modification/addition spots an incompatibility that wasn't spotted before.

Whenever the build of this repository fails, the steps to take are as follows:

1. find out what the incompatibility is,
2. find out where it originates from — typically an implementation, sometimes the specification,
3. submit an issue on the corresponding repository — which is _most likely not_ this repository,
4. fix that issue (there),
5. trigger the build here to verify it runs green again.

The build – in the form of a GitHub Action name “LionWeb integration tests” – does the following:

* validate the delta payloads under [`delta/`](delta) against the [Delta JSON Schema](https://raw.githubusercontent.com/LionWeb-io/specification/refs/heads/main/delta/delta.schema.json) for those,
* validate the _valid_ serialization chunks (recognizable as such by the presence of a `valid` fragment in their paths) under [`testchanges/`](testchanges) and [`testset/`](testset) against the [Serialization chunk JSON Schema](https://raw.githubusercontent.com/LionWeb-io/specification/refs/heads/main/serialization/serialization.schema.json) for those,
* run the integration test suite which is implemented using Deno, by running `test.sh`.
  For this suite to run, (most of) the other repositories are cloned, by running `clone.sh`.

The automated tests in the cloned repositories are **not** run.

And remember: a green build is not a guarantee for the absence of bugs (or presence of quality), but a red build is definitely a guarantee that you need to look at something.

Note also that the build sometimes fails during the “Test all C# projects” part, with something like the following in the output:

```text
  Error Message:
   System.Net.HttpListenerException : Address already in use
  Stack Trace:
     at System.Net.HttpEndPointManager.GetEPListener(String host, Int32 port, HttpListener listener, Boolean secure)
   at System.Net.HttpEndPointManager.AddPrefixInternal(String p, HttpListener listener)
   at System.Net.HttpEndPointManager.AddListener(HttpListener listener)
   at System.Net.HttpListener.Start()
   at LionWeb.WebSocket.WebSocketServer.StartServer(String ipAddress, Int32 port)
```

If this happens, then just rerun the job: usually the job succeeds the next time.
*Why* this happens is unclear to us, as we do take pains to assign each C# WebSocket server its own, unique port number.


## Installation requirements

* [Deno](https://deno.com), currently (at least) version 2.4.1 - for the integration tests written in Deno-compliant TypeScript in [`src/`](src).
  (Deno is used instead of Node.js because Deno can reliably execute TypeScript code natively.)
* Java 11 (but really Java 8) - for the [`lionweb-java` repo](repos/lionweb-java).


## Test languages

The [`src/languages`](src/languages) directory contains (artifacts relating to) several test languages — in particular the `Shapes` and `TestLanguage` languages.
The `TestLanguage` language is generated by running `generate.sh`.

